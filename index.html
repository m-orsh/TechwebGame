<html>
<head>
	<title>Game</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
</head>
<script type="text/javascript">

//CONSTANTS
var total_health_challenger;
var total_health_defender;

          /* grab the JSON for battle processing*/
var jsontest = '{"challenger":{"agent_name":null,"avatar":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/Agent1001.png","badges":[{"date_obtained":"19 Sep 2014 13:45","icon":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/AHTChatLeader.png","id":1,"name":"AHTChatLeader"},{"date_obtained":"19 Sep 2014 13:45","icon":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/FCRLeader.png","id":2,"name":"FCRLeader"},{"date_obtained":"19 Sep 2014 13:45","icon":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/NPSLeader.png","id":3,"name":"NPSLeader"},{"date_obtained":"19 Sep 2014 13:45","icon":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/F9ComplianceLeader.png","id":4,"name":"F9ComplianceLeader"}],"battles":[{"consumed":true,"date_created":"19 Sep 2014 14:39","id":1,"opponent_avatar":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/Agent2002.png","opponent_gamer_name":"Zeus Dog","opponent_id":938,"opponent_name":"Brian Griffin","win":true},{"consumed":false,"date_created":"19 Sep 2014 15:32","id":2,"opponent_avatar":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/Agent2002.png","opponent_gamer_name":"Zeus Dog","opponent_id":938,"opponent_name":"Brian Griffin","win":false}],"coins":100,"gamer_name":"Yellow Morpheus","health":186,"id":937,"level":10,"metrics":[{"attribute_name":"Hit Points","attribute_value":30,"badges_contribution":10,"base_value":20,"metric_name":"AHT Chat","metric_value":"7m 31"},{"attribute_name":"Magic Points","attribute_value":15,"badges_contribution":0,"base_value":15,"metric_name":"AHT Phone","metric_value":"13m 39"},{"attribute_name":"Strength","attribute_value":10,"badges_contribution":2,"base_value":8,"metric_name":"Reopen Rate (FCR)","metric_value":"96.5%"},{"attribute_name":"Magic Damage","attribute_value":18,"badges_contribution":0,"base_value":18,"metric_name":"Net Sales Conversion","metric_value":"47%"},{"attribute_name":"Armor","attribute_value":16,"badges_contribution":0,"base_value":16,"metric_name":"CSAT","metric_value":"86.8%"},{"attribute_name":"Weapon Damage","attribute_value":17,"badges_contribution":2,"base_value":15,"metric_name":"NPS","metric_value":"64"},{"attribute_name":"Speed","attribute_value":14,"badges_contribution":0,"base_value":14,"metric_name":"Sessions\/Hour","metric_value":"4.49"},{"attribute_name":"Intelligence","attribute_value":12,"badges_contribution":0,"base_value":12,"metric_name":"QA Score","metric_value":"87"},{"attribute_name":"Luck","attribute_value":6,"badges_contribution":1,"base_value":5,"metric_name":"F9ServiceDeliveryCompliance","metric_value":"87%"}],"xp":900},"challenger_coins":10,"challenger_xp":100,"defender":{"agent_name":null,"avatar":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/Agent2002.png","badges":[{"date_obtained":"19 Sep 2014 13:45","icon":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/AHTPhoneLeader.png","id":5,"name":"AHTPhoneLeader"},{"date_obtained":"19 Sep 2014 13:45","icon":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/CSATLeader.png","id":6,"name":"CSATLeader"},{"date_obtained":"19 Sep 2014 13:45","icon":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/RevealRecommends.png","id":7,"name":"RevealRecommends"}],"battles":[{"consumed":false,"date_created":"19 Sep 2014 14:39","id":1,"opponent_avatar":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/Agent1001.png","opponent_gamer_name":"Yellow Morpheus","opponent_id":937,"opponent_name":"Homer Simpson","win":false},{"consumed":false,"date_created":"19 Sep 2014 15:32","id":2,"opponent_avatar":"http:\/\/support.radialpoint.com\/client_images\/Radialpoint\/GameImages\/Agent1001.png","opponent_gamer_name":"Yellow Morpheus","opponent_id":937,"opponent_name":"Homer Simpson","win":true}],"coins":10,"gamer_name":"Zeus Dog","health":140,"id":938,"level":1,"metrics":[{"attribute_name":"Hit Points","attribute_value":17,"badges_contribution":0,"base_value":17,"metric_name":"AHT Chat","metric_value":"8m 11"},{"attribute_name":"Magic Points","attribute_value":21,"badges_contribution":2,"base_value":19,"metric_name":"AHT Phone","metric_value":"12m 59"},{"attribute_name":"Strength","attribute_value":19,"badges_contribution":0,"base_value":19,"metric_name":"Reopen Rate (FCR)","metric_value":"94.3%"},{"attribute_name":"Magic Damage","attribute_value":20,"badges_contribution":0,"base_value":20,"metric_name":"Net Sales Conversion","metric_value":"51%"},{"attribute_name":"Armor","attribute_value":16,"badges_contribution":2,"base_value":14,"metric_name":"CSAT","metric_value":"85.1%"},{"attribute_name":"Weapon Damage","attribute_value":15,"badges_contribution":0,"base_value":15,"metric_name":"NPS","metric_value":"66"},{"attribute_name":"Speed","attribute_value":13,"badges_contribution":0,"base_value":13,"metric_name":"Sessions\/Hour","metric_value":"4.13"},{"attribute_name":"Intelligence","attribute_value":8,"badges_contribution":0,"base_value":8,"metric_name":"QA Score","metric_value":"83"},{"attribute_name":"Luck","attribute_value":18,"badges_contribution":1,"base_value":17,"metric_name":"F9ServiceDeliveryCompliance","metric_value":"91%"}],"xp":0},"defender_coins":5,"defender_xp":50,"events":[{"agent_id":937,"attacker":"challenger","health_remaining":122,"hit":19,"id":1,"message":""},{"agent_id":938,"attacker":"defender","health_remaining":121,"hit":20,"id":2,"message":""},{"agent_id":937,"attacker":"challenger","health_remaining":99,"hit":23,"id":3,"message":"Critical Hit"},{"agent_id":938,"attacker":"defender","health_remaining":99,"hit":22,"id":4,"message":"Critical Hit"},{"agent_id":937,"attacker":"challenger","health_remaining":82,"hit":17,"id":5,"message":""},{"agent_id":938,"attacker":"defender","health_remaining":81,"hit":18,"id":6,"message":""},{"agent_id":937,"attacker":"challenger","health_remaining":61,"hit":21,"id":7,"message":"Critical Hit"},{"agent_id":938,"attacker":"defender","health_remaining":61,"hit":20,"id":8,"message":""},{"agent_id":937,"attacker":"challenger","health_remaining":40,"hit":0,"id":9,"message":""},{"agent_id":938,"attacker":"defender","health_remaining":45,"hit":16,"id":10,"message":""},{"agent_id":937,"attacker":"challenger","health_remaining":21,"hit":19,"id":11,"message":""},{"agent_id":938,"attacker":"defender","health_remaining":27,"hit":18,"id":12,"message":""},{"agent_id":937,"attacker":"challenger","health_remaining":2,"hit":19,"id":13,"message":""},{"agent_id":938,"attacker":"defender","health_remaining":5,"hit":22,"id":14,"message":"Critical Hit"},{"agent_id":937,"attacker":"challenger","health_remaining":-15,"hit":17,"id":15,"message":""}],"id":1,"type":null,"winner_id":937}';



 function battle() {
      console.log("Reading JSON");
      /*var obj = $.ajax({
                                                url: "http://10.0.55.23/HiWired.App.Web.Tech/BattleResult?BattleId="+ get_param("BattleId") +"&AgentId=" + get_param("AgentId"),
                                                type: 'get',
                                                dataType: 'json',
                                                data: {},
                                                success: function (battle) {
                                                  handle_battle_result(battle);
                                                }
                                                //error: error
                                });*/
      handle_battle_result($.parseJSON(jsontest));
    }
 
    function handle_battle_result(battle) {
      //set challenger and defender name
      $("#challenger_name_level").html(battle.challenger.gamer_name + " (" + battle.challenger.level + ")")
      $("#defender_name_level").html(battle.defender.gamer_name + " (" + battle.defender.level + ")")
 
      //set total health
      total_health_challenger = battle.challenger.health;
      total_health_defender = battle.defender.health;
 
 
      console.log(battle);
      battleProc(battle);
    }
 
    function call_setTimeout(iter,result) {

    	setTimeout(function() {(function(iter,result) {battleAnimation(result[iter].attacker, result[iter].hit, result[iter].health_remaining, result[iter].message)})(iter,result)},iter*1000 + 1300); 

    }
 
    function get_agent_id() {
                    return get_param("AgentId");
    }
 
    function get_param(query_param) {
      var agent, hash;
      var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
      for(var i = 0; i < hashes.length; i++)
      {
          hash = hashes[i].split('=');
          if(hash[0] == query_param)
          {
            return hash[1]
          }
      }
      return "Wrong url...";
    }

    function battleProc (jsonArray) {
       
       startAnimation();

       var iter = 0;
       var result = jsonArray.events;
       console.log("RESULT: " + result.length);
       while(iter<result.length){
          call_setTimeout(iter,result);
          iter++;
       }
       endAnimation(jsonArray,iter);
    }

    function startAnimation() {
    	$("#win_lose_img").attr("src","img/Fight.png");
    	$("#win_lose_img").delay(1300).animate({
    		opacity:0
    	},0,"linear", function() {
    		$("#win_lose_img").animate({
    			opacity:100
    		},0,"linear",function(){
    			$("#win_lose_img").attr("src","");
    		});
    	});

    }

    function endAnimation(jsonArray,iter) {
    	console.log("endAnimation()... " + jsonArray["winner_id"]);
    	agent = get_agent_id();
    	console.log("iter"+iter)
    	if(agent == jsonArray["winner_id"]) {
    		setTimeout(function() {$("#win_lose_img").attr("src","img/YouWin.png")},iter*1000 + 1700);

    	}
    	else {
    		setTimeout(function() {$("#win_lose_img").attr("src","img/YouLose.png")},iter*1000 + 1700);
    	}
      setTimeout(function(){$("#song").animate({volume: 0}, 1000)},iter*1000+1700)
    	
    }


    
    function battleAnimation(attacker,hit,health,message){
       $("#laser1").trigger('play');
      if(attacker=='challenger'){
      	
      	var div=$("#challenger_img");
          div.animate({
		    left:'-=400px'
		  }, 200, "linear", div.animate({
		  	left: '+=400px'
		  },200,"linear"));
		setTimeout(function() {healthAnimation(attacker,hit,health,message)},300); 
        
      }
      else if(attacker=='defender'){
         var div=$("#defender_img");
          div.animate({
		    left:'+=400px'
		  }, 200, "linear", div.animate({
		  	left: '-=400px'
		  },200,"linear") );
		  setTimeout(function() {healthAnimation(attacker,hit,health,message)},300); 
      }
    }

    function healthAnimation(attacker,hit,health,message) {
    	if(attacker=='challenger') {
    		var remaining_health_percent = ((health/total_health_defender) * 100);
    		//attack number fade out
    		if(message == "Critical Hit") {
    			$("#hidden_attack_number_c").html(hit+"</br>"+"<img src='img/CriticalHit.png'>");
    		}
    		else if(hit == 0) {
    			$("#hidden_attack_number_c").html(hit+"</br>"+"<img src='img/Miss.png'>");
    		}
    		else {
    			$("#hidden_attack_number_c").html(hit+"</br>"+message);
    		}
    		$("#hidden_attack_number_c").delay(200).animate({
    			opacity:0,
    			top: "-=100px"
    		},1000,"linear", function() {$("#hidden_attack_number_c").html("").css({"top":"300px","opacity":"1.0"})});

    		//health bar
    		$("#defender_health").delay(200).animate({
    			width:remaining_health_percent.toString() + "%"
    		},700,"linear");

    		//BUGGED
    		if(remaining_health_percent < 50) {
    			$("defender_health").delay(100).css("background-color","yellow");
    		}
    	}
    	else {
    		var remaining_health_percent = ((health/total_health_challenger)*100);
    		//attack number fade out
    		if(message == "Critical Hit") {
    			$("#hidden_attack_number_d").html(hit+"</br>"+"<img src='img/CriticalHit.png'>");
    		}
    		else if(hit == 0) {
    			$("#hidden_attack_number_d").html(hit+"</br>"+"<img src='img/Miss.png'>");
    		}
    		else {
    			$("#hidden_attack_number_d").html(hit+"</br>"+message);
    		}
    		$("#hidden_attack_number_d").delay(200).animate({
    			opacity:0,
    			top: "-=100px"
    		},1000,"linear", function() {$("#hidden_attack_number_d").html("").css({"top":"300px","opacity":"1.0"})});

    		//health bar
    		$("#challenger_health").delay(200).animate({
    			width:remaining_health_percent + "%"
    		},700,"linear");
    	}
    }


    // This is where we have all our controllers to handle events
    /*function bindUIActions() {
      //Projects Dropdown
      $(projectDropdown).on('change', function(evt, params) {
        console.log($(projectDropdown + ' option:selected').text());
        uiModel.currentProject = $(projectDropdown + ' option:selected').text();
        todoCollection.grabTodos(projectModel.getIdFromName(uiModel.currentProject).id);
        //Should cause a change in todoCollection
      });

      //Add project
      $(addProject).click(function() {
        $.ajax({
          url: "/widgets/pomo_task_manager/addProject.html",
          dataType: "html",
          success: function(data) {
            $(project).html(data);
            elementsControl.showThisSelector("project");
            bindAddProjectActions();
          }
        });
      });

      $(submitAddProject).click(function() {
          var projectName = $(inputProjectName).val();
          var projectDesc = $(inputProjectDesc).val();

          var request = gapi.client.request({
            'path': 'calendar/v3/calendars',
            'method': 'POST',
            'body': {
              'summary': "Project: " + projectName,
              'description': projectDesc
            }
          });

          var btn = $(this);
          btn.button('loading');
          request.execute(function(resp) {
            btn.button('reset');
            var name = $(inputProjectName).val()
            uiModel.currentProject = name;
            model.addCalendar(name, resp.id);
            todoCollection.grabTodos(projectModel.getIdFromName(uiModel.currentProject).id);
            elementsControl.showThisSelector("main");
          });


      });
      
    }*/

    /*function submitResults () {
      
    }


  });*/

</script>
<body onload="battle();">
	<!--main-->
	<div id="main">
		<!-- TOP PART -->
		<audio id="song" src="battle.wav" controls="controls" autoplay style="display:none" loop volume="0.5"></audio>
		<audio id="laser1" src="LaserGun02.mp3" controls="controls" style="display:none"></audio>

		<!-- Winner/loser flag -->
		<div id="win_lose_flag">
			<img id="win_lose_img">
		</div>

		<!-- hidden attack number div -->
		<div id="hidden_attack_number_c">
		</div>
		<div id="hidden_attack_number_d">
		</div>


		<div id="challenger_ui">
			<h2 id="challenger_name_level">
			</h2>
			<img id="challenger_img" src="http://support.radialpoint.com/client_images/Radialpoint/GameImages/Agent1001.png">
			
			<div id="challenger_health_wrapper">
       			<div id="challenger_health">
       			</div>
     		</div>
     		
		</div>
		<div id="defender_ui">
			<h2 id="defender_name_level">
			</h2>
			<img id="defender_img" src="http://support.radialpoint.com/client_images/Radialpoint/GameImages/Agent2002.png">

			<div id="defender_health_wrapper">
	       		<div id="defender_health">
	     		</div>
			</div>
		</div>

		<!--
		<div id="challenger_stats_wrapper">
			<table class="stats_table">
				<tr class="table_header_row">
					<th colspan="2">Challenger statistics</th>
				</tr>
				<tr class="table_odd_row">
					<td id="challenger_real_name">challenger_real_name</td>
					<td id="challenger_armour">challenger_armour</td>
				</tr>
				<tr class="table_even_row">
					<td id="challenger_hit_points">challenger_hit_points</td>
					<td id="challenger_weapon_damage">challenger_weapon_damage</td>
				</tr>
				<tr class="table_odd_row">
					<td id="challenger_magic_points">challenger_magic_points</td>
					<td id="challenger_speed">challenger_speed</td>
				</tr>
				<tr class="table_even_row">
					<td id="challenger_strength">challenger_strength</td>
					<td id="challenger_intelligence">challenger_intelligence</td>
				</tr>
				<tr class="table_odd_row">
					<td id="challenger_magic_damage">challenger_magic_damage</td>
					<td id="challenger_luck">challenger_luck</td>
				</tr>
			</table>
		</div>

		<div id="defender_stats_wrapper">
			<table class="stats_table">
				<tr class="table_header_row">
					<th colspan="2">Defender statistics</th>
				</tr>
				<tr class="table_odd_row">
					<td id="defender_real_name">defender_real_name</td>
					<td id="defender_armour">defender_armour</td>
				</tr>
				<tr class="table_even_row">
					<td id="defender_hit_points">defender_hit_points</td>
					<td id="defender_weapon_damage">defender_weapon_damage</td>
				</tr>
				<tr class="table_odd_row">
					<td id="defender_magic_points">defender_magic_points</td>
					<td id="defender_speed">defender_speed</td>
				</tr>
				<tr class="table_even_row">
					<td id="defender_strength">defender_strength</td>
					<td id="defender_intelligence">defender_intelligence</td>
				</tr>
				<tr class="table_odd_row">
					<td id="defender_magic_damage">defender_magic_damage</td>
					<td id="defender_luck">defender_luck</td>
				</tr>
			</table>
		</div>
	-->
	</div>	
</body>
</html>